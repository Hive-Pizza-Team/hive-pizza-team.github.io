<!-- <!DOCTYPE html> -->
<!-- Created by peakd.com/@hivetrending -->

<meta charset="utf-8">
<html>
<head>
  <title>Pizza Kings</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.0/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

</head>


<body>

    <div class="col-lg-8 mx-auto p-3 py-md-5">
    <h1><img width="8%" src="https://files.peakd.com/file/peakd-hive/dibblers.dabs/23uQNzfZigGqCxZsZS33wLNhi5zprshnmUbRTqFxk5G8whe9peSXPPEC7vEuQ19vXxa9f.png"> Pizza Kings</h1>

    <h2>HashKings Plots</h2><br>
    <!--<button class="btn btn-secondary">PLANT ALL</button>-->
    <!--<button class="btn btn-primary">WATER ALL</button>-->
    
    <table id="plots_table" class="table table-striped">

    </table>

    
    <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
    <div class="col-md-4 d-flex align-items-center">

      <span class="text-muted">Brought to you by <a href="https://peakd.com/@HiveTrending">@hivetrending</a> and the <a href="https://vote.hive.uno/@pizza.witness">@pizza.witness</a> team.</span>
    </div>
  </footer>
    </div>



<script>

//var wallet = 

var urlParams = new URLSearchParams(window.location.search)
const DEFAULT_ACCOUNT = 'null'
var ACCOUNT = urlParams.has('account') ? urlParams.get('account').toLowerCase() : DEFAULT_ACCOUNT

if (ACCOUNT === DEFAULT_ACCOUNT) {
    ACCOUNT = window.prompt('Enter Hive account name:')
}

const rpc = 'https://api2.hive-engine.com/rpc/contracts';
function getOwnedPlots(account) {
    return new Promise((resolve, reject) => {
        const query = {'id': 1,
                       'jsonrpc': '2.0',
                       'method': 'find',
                       'params': {
                            'contract': 'nft',
                            'table': 'HKFARMinstances',
                            'query': {
                                'properties.TYPE': 'plot',
                                'account': account
                            }
                        }}
        axios.post(rpc, query).then((result) => {
            return resolve(result.data.result)
        }).catch((err) => {
            console.log(err)
            return reject(err)
        })
    })
}

function getRentedPlots(account) {
    return new Promise((resolve, reject) => {
        const query = {'id': 1,
                       'jsonrpc': '2.0',
                       'method': 'find',
                       'params': {
                            'contract': 'nft',
                            'table': 'HKFARMinstances',
                            'query': {
                                'properties.TYPE': 'plot',
                                'properties.RENTEDINFO': account
                            }
                        }}
        axios.post(rpc, query).then((result) => {
            return resolve(result.data.result)
        }).catch((err) => {
            console.log(err)
            return reject(err)
        })
    })
}

function getSeeds(account) {
    return new Promise((resolve, reject) => {
        const query = {'id': 1,
                       'jsonrpc': '2.0',
                       'method': 'find',
                       'params': {
                            'contract': 'nft',
                            'table': 'HKFARMinstances',
                            'query': {
                                'properties.TYPE': 'seed',
                                'account': account
                            }
                        }}
        axios.post(rpc, query).then((result) => {
            return resolve(result.data.result)
        }).catch((err) => {
            console.log(err)
            return reject(err)
        })
    })
}

//[{"method":"find","jsonrpc":"2.0","params":{"contract":"nft","table":"HKFARMinstances","query":{"properties.TYPE":"seed","properties.NAME":{"$in":["Acapulco Gold","Blue Dream","Bubblegum","Critical Kush","Shaggiâ€™s Dream","Purple Haze","Snoops Dream"]},"account":"hivetrending"},"limit":1000,"offset":0,"indexes":[]},"id":1}]

function zip(arrays) {
    return arrays[0].map(function(_,i){
        return arrays.map(function(array){return array[i]})
    });
}


function harvestSingle(wallet, seedID) {
    custom_json_id = 'ssc-mainnet-hive'

    let json_payload = {
        'contractName': 'nft',
        'contractAction': 'transfer',
        'contractPayload':{
            'to':'hk-vault',
            'nfts':[
                {'symbol':'HKFARM',
                 'ids':[
                    String(seedID)
                  ]
                }
            ]
        }
    }

    json_payload = JSON.stringify(json_payload)

    console.log(json_payload)

    hive_keychain.requestCustomJson(
        wallet,
        custom_json_id,
        'Active',
        json_payload,
        `Harvesting HK Plot for Seed ${seedID}`,
        function(response) {
            console.log(response);
            if (!response['success']) {
                console.log(`Failure! Keychain failed to authorize the transaction for @${wallet}`)
            } else {
                console.log(`Success! Plot planted for @${wallet}`)
            }
        }
    )
}


function harvestMultiple(wallet, seedIDs) {

    if (seedIDs.length == 0) {
        window.alert('Nothing to harvest!')
    }

    for (seedID of seedIDs) {
        continue_message = `Are you sure you want to harvest seed ${seedID}?`
        should_continue = window.confirm(continue_message)

        if (!should_continue) {
            break
        }
        harvestSingle(wallet, seedIDs)
    }
}


Promise.all([getOwnedPlots(ACCOUNT),getRentedPlots(ACCOUNT),getSeeds(ACCOUNT)]).then( (values) => {
    let [ownedPlots, rentedPlots, seeds] = values

    let allPlots = ownedPlots.concat(rentedPlots)

    let table_markup = '<thead><th>id</th><th>Region</th><th>Rented</th><th>Seed ID</th><th>Planted Seed</th><th>Water</th><th>Yield</th><th>Time Left</th><th colspan="3"><button title="Harvest All" class="btn btn-success" id="harvest-all"><i class="fa-solid fa-scissors"></i> ALL</button><br>Actions</th>'

    var seedsByID = {}
    var seedsReady = []
    for (seed of seeds) {
        seedsByID[seed._id] = seed
        //console.log(seed)

        let seedTime  = seed.properties.SPT
        if (seedTime === 0) {
            seedsReady.push(seed._id)
        }
    }

    for (plot of allPlots) {
        //console.log(plot)
        let plantedSeedID = plot.properties.SEEDID

        let seedName  = ''
        let seedWater = ''
        let seedYield = ''
        let seedTime  = ''

        let plantBtn   = ''//'<button title="Plant" class="btn btn-secondary" disabled="disabled"><i class="fa-solid fa-seedling"></i></button>'
        let waterBtn   = ''//`<button title="Water" class="btn btn-primary" disabled="disabled"><i class="fa-solid fa-hand-holding-droplet"></i></button>`
        let harvestBtn = '<button title="Harvest" class="btn btn-success" disabled="disabled"><i class="fa-solid fa-scissors"></i></button>'


        if (plot.properties.SEEDID != 0 && seedsByID[plot.properties.SEEDID] !== undefined) {
            seedName  = seedsByID[plantedSeedID].properties.NAME
            seedWater = seedsByID[plantedSeedID].properties.WATER
            seedYield = seedsByID[plantedSeedID].properties.PR
            seedTime  = seedsByID[plantedSeedID].properties.SPT

            if (seedWater !== 0) {
                waterBtn = `<button title="Water" class="btn btn-primary"><i class="fa-solid fa-hand-holding-droplet"></i></button>`
            }

            if (seedTime === 0) {
                harvestBtn = `<button title="Harvest" class="btn btn-success" onClick="harvestSingle('${ACCOUNT}',${plantedSeedID})"><i class="fa-solid fa-scissors"></i></button>`
            }
        } else {
            plantBtn = ''//<button title="Plant" class="btn btn-primary"><i class="fa-solid fa-hand-holding-seedling"></i></button>'
        }

        if (plantedSeedID == 0) {
            plantedSeedID = 'Empty'
        }

        table_markup += `<tr><td>${plot._id}</td><td>${plot.properties.NAME}</td><td>${plot.properties.RENTED}</td><td>${plantedSeedID}</td><td>${seedName}</td><td>${seedWater}</td><td>${seedYield}</td><td>${seedTime}</td><td>${plantBtn}</td><td>${waterBtn}</td><td>${harvestBtn}</td></tr>`
    }


    document.querySelector('table#plots_table').innerHTML = table_markup

    document.querySelector('button#harvest-all').onclick = function () {
        harvestMultiple(ACCOUNT,seedsReady)
    }
})


// plots

/*
var plots = [

]

// seeds
var seeds = [
]

var to_plant = zip([plots, seeds])

console.log(to_plant)

custom_json_id = 'qwoyn_plant_plot'


for ([plotID, seedID] of to_plant) {
    // {"plotID":"2791","seedID":"633616"}

    let json_payload = {'plotID': plotID, 'seedID': seedID}

    json_payload = JSON.stringify(json_payload)
    console.log(json_payload)

    continue_message = `Are you sure you want to plant seed ${seedID}, on plot ${plotID}`
    should_continue = window.confirm(continue_message)

    let resultPromise = hive_keychain.requestCustomJson(
        wallet,
        custom_json_id,
        'Active',
        json_payload,
        `Planting HK Plots`,
        function(response) {
            console.log(response);
            if (!response['success']) {
                console.log(`Failure! Keychain failed to authorize the transaction for @${wallet}`)
            } else {
                console.log(`Success! Plot planted for @${wallet}`)
            }
        }
    )
}
*/


</script>
</body>


</html>